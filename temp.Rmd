---
title: 'Code description'
output:
 html_document:
  toc: true
---

## About

This document describes the R code used in Wallace.

## Packages instalation

Before start, install the following packages:
```{r, eval = FALSE}
install.packages(devtools)
install.packages(rgbif)
install.packages(maptools)
install.packages(spThin)
install.packages(ENMeval)
install.packages(dismo)
install.packages(rgeos)
install.packages(repmis)
```

Now load them:
```{r, message = FALSE}
library(devtools)
library(rgbif)
library(maptools)
library(spThin)
library(ENMeval)
library(dismo)
library(rgeos)
library(repmis)
```

Load the functions necessary to run the analysis:
```{r}
source('functions.R')
```

## Obtain occurrence data 

The analysis will be done for the following species:
```{r}
gbifName <- 'tremarctos ornatus'
```

The search of occurrences will be limited to:
```{r}
occurrences <- 20
```

Apply the function to obtain the gbif records for the selected species:
```{r, warning = FALSE, message = FALSE}
results <- occ_search(scientificName = gbifName, limit = occurrences, hasCoordinate = TRUE)
```

Rename the results:
```{r, warning = FALSE, message = FALSE}
gbifOrig <- results
```

Occurrence table changes:
```{r, warning = FALSE, message = FALSE}
 cols <- c("name", "decimalLongitude", "decimalLatitude", "country", "stateProvince", "locality", "elevation", "basisOfRecord")
 locs.in <- results$data[!is.na(results$data[, 3]), ][, cols]
 locs <- remDups(locs.in)
 names(locs)[2:3] <- c("lon", "lat")
 locs$origID <- row.names(locs)

```

Create the null object:
```{r, warning = FALSE, message = FALSE}
gbifoccs <- NULL
```

Adjusting table values:
```{r, warning = FALSE, message = FALSE}
 gbifoccs <- rbind(gbifoccs, locs)
 gbifoccs <- remDups(gbifoccs)
 df <- gbifoccs

```

## Process occurrence data

Selected points with the polygon:
```{r}
ptseln <- c(1, 3, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18)
```

Subset with selected points:
```{r, warning = FALSE, message = FALSE}
 ptsSel <- gbifoccs[ptseln, ]
 df <- ptsSel

```

Thin distance:
```{r}
thinDist <- 20
```

Thin occurrence records:
```{r, warning = FALSE, message = FALSE}
output <- thin(df, "lat", "lon", "name", thin.par = thinDist, reps = 100, locs.thinned.list.return = TRUE, write.files = FALSE, verbose = FALSE)
```

Change df to thinned data:
```{r, warning = FALSE, message = FALSE}
 maxThin <- which(sapply(output, nrow) == max(sapply(output, nrow)))
 maxThin <- output[[ifelse(length(maxThin) > 1, maxThin[1], maxThin)]]
 df <- df[as.numeric(rownames(maxThin)), ]

```

Resolution of worldclim data:
```{r}
pred <- '10'
```

Donwload environmental data
```{r, warning = FALSE, message = FALSE}
pred <- getData(name = "worldclim", var = "bio", res = pred)
```

Extract environmental values
```{r, warning = FALSE, message = FALSE}
locs.vals <- extract(pred[[1]], df[, 2:3])
```

Remove occurrence without environmental data:
```{r, warning = FALSE, message = FALSE}
df <- df[!is.na(locs.vals), ]
```


```{r}
locs.vals
```

