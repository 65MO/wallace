---
title: 'Code history for Wallace session 2015-09-04'
---

## About

This is an R Markdown document (more information on http://rmarkdown.rstudio.com/). Here all R code history from the Wallace session is recorded and annotated. With this document, users can track their own analysis and reproduce it by running the code.

## Package installation

Wallace uses the following R packages that need to be installed before starting:
```{r, eval = FALSE}
install.packages(devtools)
install.packages(rgbif)
install.packages(maptools)
install.packages(spThin)
install.packages(dismo)
install.packages(rgeos)
install.packages(repmis)
install.packages(maps)
```

Once installed, load them:
```{r, message = FALSE}
library(devtools)
library(rgbif)
library(maptools)
library(spThin)
library(dismo)
library(rgeos)
library(repmis)
library(maps)
```

Now install and load a development version of ENMeval and load it:
```{r, message = FALSE, warnings = FALSE}
install_github("bobmuscarella/ENMeval@edits")
library(ENMeval)

```

Wallace also includes several functions developed to help integrate different packages and some additional functionality. For this reason, it is necessary to load the file 'functions.R', which can be found on Wallace's GitHub page (https://github.com/ndimhypervol/wallace). Download the file, place it in your working directory (use `getwd()`), and then load it:
```{r}
source('functions.R')
```

## Obtain Occurrence Data 

Record of analysis for:
```{r}
gbifName <- 'tremarctos ornatus'
```

The search for occurrences will be limited to the user-specified number of records:
```{r}
occurrences <- 20
```

The following command obtains occurrence records of the selected species from GBIF:
```{r, warning = FALSE, message = FALSE}
results <- occ_search(scientificName = gbifName,
   limit = occurrences,
   hasCoordinate = TRUE)
```

Rename the results (Wallace internal needs):
```{r, warning = FALSE, message = FALSE}
gbifOrig <- results
```

Change the name of the occurrence record table:
```{r, warning = FALSE, message = FALSE, results = 'hide'}
cols <- c("name",
     "decimalLongitude",
     "decimalLatitude",
     "institutionCode",
     "country",
     "stateProvince",
     "locality",
     "elevation",
     "basisOfRecord")
results <- fixcols(cols, results)
locs.in <- results$data[!is.na(results$data[, 3]), ][, cols]
locs <- remDups(locs.in)
names(locs)[1:3] <- c("species", "longitude", "latitude")
locs$origID <- row.names(locs)

```

Adjust the formatting of the results table:
```{r, warning = FALSE, message = FALSE, results = 'hide'}
gbifoccs <- locs
gbifoccs <- remDups(gbifoccs)
df <- gbifoccs

```

## Process Occurrence Data

## Obtain Environmental Data

User-selected resolution of WorldClim (http://www.worldclim.org/) data to use:
```{r}
pred <- '10'
```

Donwload environmental data
```{r, warning = FALSE, message = FALSE}
preds <- getData(name = "worldclim", var = "bio", res = pred)
```

Extract environmental values to check for NA:
```{r, warning = FALSE, message = FALSE}
locs.vals <- extract(preds[[1]], df[, 2:3])
```

Remove occurrence localities without environmental values
```{r, warning = FALSE, message = FALSE}
df <- df[!is.na(locs.vals), ]
```

## Process Environmental Data

Define user study extent:
```{r, warning = FALSE, message = FALSE, results = 'hide', eval = FALSE}
userBackg <- NULL
```

User study extent name:
```{r, eval = FALSE}
name <- 'mcp.shp'
```

User study extent path (change to the path of the file in your computer):
```{r, eval = FALSE}
datapath <- '/var/folders/n5/3tmt4rm13657q2dz_5nkmtyw0000gq/T//Rtmpf4eFTk/e68199de2b175652ebe150ea/0'
```

Adjust path and names to load the study extent:
```{r, warning = FALSE, message = FALSE, results = 'hide', eval = FALSE}
names <- userBackg$name
inPath <- userBackg$datapath
pathdir <- dirname(inPath)
pathfile <- basename(inPath)

```

Get extensions of all input files:
```{r, warning = FALSE, message = FALSE, eval = FALSE}
exts <- sapply(strsplit(names, "\\."), FUN = function(x) x[2])
```

Define user study extent:
```{r, warning = FALSE, message = FALSE, results = 'hide', eval = FALSE}
userBackg <- NULL
```

User study extent name:
```{r, eval = FALSE}
name <- 'poly.csv'
```

User study extent path (change to the path of the file in your computer):
```{r, eval = FALSE}
datapath <- '/var/folders/n5/3tmt4rm13657q2dz_5nkmtyw0000gq/T//Rtmpf4eFTk/d712ee5e9b79b5cbd3c48159/0'
```

Adjust path and names to load the study extent:
```{r, warning = FALSE, message = FALSE, results = 'hide', eval = FALSE}
names <- userBackg$name
inPath <- userBackg$datapath
pathdir <- dirname(inPath)
pathfile <- basename(inPath)

```

Get extensions of all input files:
```{r, warning = FALSE, message = FALSE, eval = FALSE}
exts <- sapply(strsplit(names, "\\."), FUN = function(x) x[2])
```

Define the buffer size of the study extent:
```{r, eval = FALSE}
backgBuf <- 0
```

Read the shapefile for the study extent:
```{r, warning = FALSE, message = FALSE, eval = FALSE}
shp <- read.csv(inPath, header = TRUE)
```

Generate the user-defined study extent plus the buffer:
```{r, warning = FALSE, message = FALSE, results = 'hide', eval = FALSE}
shp <- SpatialPolygons(list(Polygons(list(Polygon(shp)), 1)))
shp <- gBuffer(shp, width = backgBuf + res(preds)[1])
backgExt <- shp
bb <- shp@polygons[[1]]@Polygons[[1]]@coords

```

Mask environmental variables by user-defined:
```{r, warning = FALSE, message = FALSE, results = 'hide', eval = FALSE}
predCrop <- crop(preds, backgExt)
predsMsk <- mask(predCrop, backgExt)

```